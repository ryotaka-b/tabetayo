<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.json">
<title>ã”ã¯ã‚“ãƒ¡ãƒ¢</title>
<style>
  body { font-family: -apple-system, system-ui; margin: 16px; }
  header { display:flex; gap:8px; align-items:center; }
  input, textarea, select, button { font-size:16px; width:100%; padding:10px; margin-top:8px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .card { border:1px solid #ddd; border-radius:10px; padding:10px; margin:10px 0; }
  .thumb { width:100%; height:auto; border-radius:8px; }
  .meta { font-size:12px; color:#666; margin-top:4px; }
  .actions { display:flex; gap:8px; margin-top:8px; }
  #list { margin-top:12px; }
  #empty { color:#999; text-align:center; margin-top:24px; }
</style>
<body>
<header>
  <h1 style="margin:0">ğŸš ã”ã¯ã‚“ãƒ¡ãƒ¢</h1>
</header>

<!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="card">
  <input type="file" id="photo" accept="image/*" capture="environment">
  <input id="title" placeholder="åº—å or å•†å“å">
  <div class="row">
    <input id="place" placeholder="å ´æ‰€ï¼ˆä»»æ„ï¼‰">
    <select id="rating" aria-label="è©•ä¾¡">
      <option value="">â˜…è©•ä¾¡ï¼ˆä»»æ„ï¼‰</option>
      <option>â˜…â˜†â˜†â˜†â˜†</option><option>â˜…â˜…â˜†â˜†â˜†</option>
      <option>â˜…â˜…â˜…â˜†â˜†</option><option>â˜…â˜…â˜…â˜…â˜†</option><option>â˜…â˜…â˜…â˜…â˜…</option>
    </select>
  </div>
  <textarea id="note" rows="3" placeholder="æ„Ÿæƒ³ï¼ˆå‘³ãƒ»é‡ãƒ»ä¾¡æ ¼ãƒ»ã¾ãŸè¡Œãï¼Ÿãªã©ï¼‰"></textarea>
  <button id="save">ä¿å­˜ã™ã‚‹</button>
</div>

<!-- æ¤œç´¢ -->
<input id="q" placeholder="æ¤œç´¢ï¼ˆåº—å/å•†å“åãƒ»æ„Ÿæƒ³ï¼‰">

<div id="list"></div>
<div id="empty" hidden>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>

<script>
/* ===== IndexedDBï¼ˆç”»åƒå«ã‚€ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ ===== */
const DB_NAME = 'meals-db', STORE = 'entries', VER = 1;
function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, VER);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)) {
        const os = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement:true });
        os.createIndex('createdAt','createdAt');
      }
    };
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}
async function tx(mode='readonly') {
  const db = await openDB();
  return db.transaction(STORE, mode).objectStore(STORE);
}
async function addEntry(entry) {
  const store = await tx('readwrite');
  return new Promise((res, rej)=>{
    const r = store.add(entry);
    r.onsuccess = ()=>res(r.result);
    r.onerror = ()=>rej(r.error);
  });
}
async function getAll() {
  const store = await tx('readonly');
  return new Promise((res, rej)=>{
    const r = store.getAll();
    r.onsuccess = ()=>res(r.result.sort((a,b)=>b.createdAt-a.createdAt));
    r.onerror = ()=>rej(r.error);
  });
}
async function remove(id) {
  const store = await tx('readwrite');
  return new Promise((res, rej)=>{
    const r = store.delete(id);
    r.onsuccess = ()=>res(true);
    r.onerror = ()=>rej(r.error);
  });
}

/* ===== ç”»åƒã‚’ç¸®å°ï¼ˆé•·è¾º1280pxï¼‰ã—ã¦BlobåŒ– ===== */
function fileToResizedBlob(file, max=1280, type='image/jpeg', quality=0.9) {
  return new Promise((res, rej)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => { img.src = e.target.result; };
    reader.onerror = rej;
    img.onload = ()=>{
      let {width:w, height:h} = img;
      const scale = Math.min(1, max / Math.max(w,h));
      const cw = Math.round(w*scale), ch = Math.round(h*scale);
      const c = document.createElement('canvas');
      c.width = cw; c.height = ch;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);
      c.toBlob(b => res(b), type, quality);
    };
    img.onerror = rej;
    reader.readAsDataURL(file);
  });
}

/* ===== UI ===== */
const el = id => document.getElementById(id);
const photo = el('photo'), titleEl = el('title'), placeEl = el('place');
const ratingEl = el('rating'), noteEl = el('note'), saveBtn = el('save');
const q = el('q'), list = el('list'), empty = el('empty');

function fmtDate(ts){
  const d = new Date(ts);
  const pad = n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

async function render(filter=''){
  const items = await getAll();
  list.innerHTML = '';
  const f = filter.trim().toLowerCase();
  let cnt = 0;
  for(const it of items){
    const hay = `${it.title||''} ${it.place||''} ${it.note||''}`.toLowerCase();
    if(f && !hay.includes(f)) continue;
    cnt++;
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.className='thumb';
    if (it.photoURL) { img.src = it.photoURL; card.appendChild(img); }
    const h2 = document.createElement('h3'); h2.textContent = it.title || '(åç§°æœªå…¥åŠ›)';
    const meta = document.createElement('div'); meta.className='meta';
    meta.textContent = [it.place, it.rating, fmtDate(it.createdAt)].filter(Boolean).join('ãƒ»');
    const memo = document.createElement('div'); memo.textContent = it.note || '';
    const actions = document.createElement('div'); actions.className='actions';
    const del = document.createElement('button'); del.textContent = 'å‰Šé™¤';
    del.onclick = async ()=>{ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ await remove(it.id); render(q.value); } };
    actions.appendChild(del);
    card.append(h2, meta, memo, actions);
    list.appendChild(card);
  }
  empty.hidden = cnt !== 0;
}

saveBtn.onclick = async ()=>{
  saveBtn.disabled = true;
  try{
    let blob = null, url = '';
    if (photo.files && photo.files[0]) {
      blob = await fileToResizedBlob(photo.files[0]);
      url = URL.createObjectURL(blob);
    }
    const entry = {
      title: titleEl.value.trim(),
      place: placeEl.value.trim(),
      rating: ratingEl.value,
      note: noteEl.value.trim(),
      createdAt: Date.now(),
      photo: blob,          // Blobæœ¬ä½“ï¼ˆIndexedDBã«ä¿å­˜ï¼‰
      photoURL: url         // è¡¨ç¤ºç”¨ã®ä¸€æ™‚URL
    };
    await addEntry(entry);
    titleEl.value = ''; placeEl.value=''; ratingEl.value=''; noteEl.value=''; photo.value='';
    render(q.value);
    alert('ä¿å­˜ã—ã¾ã—ãŸ');
  } catch(e){ alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e); }
  finally{ saveBtn.disabled = false; }
};

q.oninput = ()=>render(q.value);

/* Service Workerç™»éŒ² */
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }

/* èµ·å‹•æ™‚è¡¨ç¤º */
render();
</script>
</body>
</html>
